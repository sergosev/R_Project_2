---
title: "R_Project_1"
output: html_document
date: "2025-09-22"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      error = FALSE,
                      warning = FALSE)

#Задаем рабочую директорию
main_dir <- dirname(rstudioapi::getSourceEditorContext()$path) 
setwd(main_dir)

#Подгружаем библиотеки
library(tidyr)
library(dplyr)
library(ggplot2)
library(flextable)
library(psych)
library(tibble)
library(DescTools) # для определения доверительных интервалов и их иллюстрации в Bar plots
```

# Анализ данных сервиса проката велосипедов

Сервисы проката велосипедов и самокатов продолжают набирать популярность благодаря своему удобству и скорости. Однако, они довольно сильно зависят от погодных условий, времени года и вида дня (рабочий или нерабочий). В нашем распоряжении есть дневные данные сервиса проката велосипедов в Вашингтоне за 2011-2012 годы. Данный проект направлен на исследование влияния погодных условий и других факторов на количество арендованных велосипедов.

## Обзор и подготовка данных

Для начала загрузим исходный датафрейм и изучим его содержимое:

```{r data acquire, include=TRUE}
#Загружаем таблицу
data <- read.csv("day.csv", header = T)
str(data)
```

Мы имеем следующие переменные:

1.  `instant`: id наблюдения
2.  `dteday`: дата - season: время года - категориальная переменная
3.  `yr`, `mnth`: год (2011/2012) и месяц - категориальные переменные
4.  `holiday`: наличие праздника в этот день - категориальная переменная
5.  `weekday`: день недели - категориальная переменная
6.  `workingday`: рабочий день или выходной - категориальная переменная
7.  `weathersit`: погода - категориальная переменная
8.  `temp`, `atemp`: реальная нормированная температура и субъективная нормированная оценка температуры - количественные переменные
9.  `hum`, `windspeed`: нормированные влажность и скорость ветра - количественные переменные
10. `casual`: число случайных клиентов сервиса - количественная переменная
11. `registered`: число зарегистрированных клиентов сервиса - количественная переменная
12. `cnt`: сумма casual и registered - количественная переменная переменная

Функция str() показала, что далеко не все переменные были распознаны правильно при считывании таблицы, многие категориальные переменные указаны, как целочисленные). Перейдем к подготовке данных: разберемся с отсутствующими и выпадающими значениями, а также присвоим правильные типы данных столбцам таблицы.

### Отсутствующие значения

Подсчитаем количество отсутствующих значений в колонках

```{r count NAs, include=TRUE}
sapply(data, FUN = function(x) {
  table(is.na(x))[2]
})
```

NA есть в столбцах `temp`, `hum`, `windspeed` и `registered`. Всего отсутствующих значений 9, их удаление в масштабе набора из 700+ наблюдений едва ли повлияет на результаты анализа. Удалим эти наблюдения:

```{r delete NA, include=TRUE}
data_wo_na <- na.omit(data)
```

### Установка типов данных

Посмотрим на уникальные значения категориальных переменных.

```{r find unique, include=TRUE}
sapply(data_wo_na[c(3:9)], FUN = function(x) {
  unique(x)
})
```

Как мы видим, число уникальных значений для каждой категориальной переменной совпадает с ожидаемым числом уровней. Нет необходимости работать с опечатками, можно задавать всем категориальным переменным тип factor.

```{r factor setup, unclude=TRUE}
fac_data_wo_na <- data_wo_na %>%
  mutate(dteday = as.Date(dteday)) %>%
  mutate(season = as.factor(recode(season, "1"="Winter", "2"="Spring", "3"="Summer", "4"="Fall"))) %>%
  mutate(yr = as.factor(ifelse(yr == "0", "2011", "2012"))) %>%
  mutate(mnth = as.factor(recode(mnth, "1"="Jan", "2"="Feb", "3"="Mar",
                       "4"="Apr", "5"="May", "6"="Jun",
                       "7"="Jul", "8"="Aug", "9"="Sep",
                       "10"="Oct", "11"="Nov", "12"="Dec"))) %>%
  mutate(weekday = as.factor(weekdays(dteday, abbreviate = T))) %>%
  mutate(holiday = as.factor(ifelse(holiday == "0", "no", "yes"))) %>%
  mutate(workingday = as.factor(ifelse(workingday == "0", "no", "yes"))) %>%
  mutate(weathersit = as.factor(recode(weathersit, "1"="Clear",
                                       "2"="Fog/Cloudy", "3"="Snow/rain")))
           
str(fac_data_wo_na)
```

### Работа с выбросами

Проверим числовые переменные на наличие выбросов:

```{r outliers plot, include=TRUE, echo=FALSE}
outlier_graph_data <- fac_data_wo_na %>%
  select(where(~ is.numeric(.) | is.integer(.))) %>% # выбрали количественные переменные
  pivot_longer(-instant, names_to = "vars1", values_to = "vals1") %>% # перевели в длинный формат
  full_join(fac_data_wo_na %>%                              #объединяем с такой же длинной таблицей попарно
              select(where(~ is.numeric(.) | is.integer(.))) %>%
              pivot_longer(-instant, names_to = 'vars2', values_to = 'vals2'),
            by = 'instant') %>%
  filter(vars1 != vars2)   # удаляем диагональ

ggplot(outlier_graph_data, aes(x = vals1, y = vals2))+ # создаем оси Х и У
  geom_point(size=0.5)+ # рисуем дот плот
  facet_grid(vars2 ~ vars1, scales='free')+
  theme_bw()# делим дот плоты по соответствующим панелям
```

Видно, что в переменной `atemp` есть значение, которое оказалось неожиданно низким по сравнению с соответствующим значением переменной `temp`. Либо в этот день было относительно тепло, но клиентам сервиса казалось, что погода наоборот холодная, либо закралась некая ошибка при вводе данных. Удаляем этот выброс:

```{r remove outliers}
fac_data_wo_na_and_outs <- fac_data_wo_na %>% filter(!(atemp < 0.3 & temp > 0.5))
```

Также в переменной `hum` можно увидеть 2 очень низких значения, которые выбиваются из остального набора измерений. Одно из таких измерений равно 0, что практически невозможно.

```{r boxplot, echo = F}
fac_data_wo_na_and_outs %>%
  select(c('hum', 'temp', 'atemp', 'windspeed')) %>%
  pivot_longer(cols = everything(), names_to = "variable", 'values_to' = 'value') %>%
  mutate(variable = as.factor(variable)) %>%
  ggplot(aes(y=value, x = variable))+
  geom_boxplot()
```

Однако если посмотреть на графики по переменным `hum` и `casual`, `registered`, `cnt`, то становится заметно, что этим низким измерениям влажности соответствует и низкое число клиентов сервиса проката. Вероятно, между этими переменными существует взаимосвязь, поэтому не стоит пока что удалять второй выброс. Удалим только `hum == 0`:

```{r}
fac_data_wo_na_and_outs <- fac_data_wo_na_and_outs %>% filter(hum!=0)
```

Также в переменной `windspeed` также есть ряд выбросов, один из которых сильно выше остального набора измерений. Тем не менее взаимосвязь этой переменной с другими пока не была изучена и удалять эти выбросы преждевременно также не стоит.

Сравним изменения средний, стандартных отклонений и доверительных интервалов для переменных, выбросы из которых мы удалили:

```{r outlier check, echo = FALSE}
after <- fac_data_wo_na_and_outs %>%
  select(c(hum, temp, atemp)) %>%
  pivot_longer(
    everything(),
    names_to = "variable",
    values_to = "value"
  ) %>%
  group_by(variable) %>%
  summarise(
    "Mean" = round(mean(value, na.rm = TRUE), 2),
    "SD" = round(sd(value, na.rm = TRUE), 2),
    "Lower_CI" = round(as.numeric(MeanCI(value, method = "boot")["lwr.ci"]),3),
    "Upper_CI" = round(as.numeric(MeanCI(value, method = "boot")["upr.ci"]),3)
  )

before <- fac_data_wo_na %>%
  select(c(hum, temp, atemp)) %>%
  pivot_longer(
    everything(),
    names_to = "variable",
    values_to = "value"
  ) %>%
  group_by(variable) %>%
  summarise(
    "Mean" = round(mean(value, na.rm = TRUE), 2),
    "SD" = round(sd(value, na.rm = TRUE), 2),
    "Lower_CI" = round(as.numeric(MeanCI(value, method = "boot")["lwr.ci"]),3),
    "Upper_CI" = round(as.numeric(MeanCI(value, method = "boot")["upr.ci"]),3)
  )

comparison <- rbind(before, after)
colnames(comparison)[1] <- "Variable"
comparison <- comparison %>%
  mutate("Status" = c(rep("Before removing outliers", 3), rep("After removing outliers", 3))) %>%
  relocate("Status", .before=1)

comparison %>%
  flextable() %>%
  merge_v("Status") %>%
  align(align="center")
  
```

Среднее и разброс данных не изменились для наших переменных, однако немного поменялись границы доверительных интервалов. Учитывая изменения доверительного интервала на тысячные доли единицы можно сказать, что удаление выбросов незначительно повлияло на данные.

Мы проверили данные на наличие выбросов, убрали отсутствующие значения и присвоили категориальным переменным правильный тип данных. Можно переходить к разведочному анализу данных.

```{r working df, include=T}
work_data <- fac_data_wo_na_and_outs
```

## Разведочный анализ данных

Посмотрим на результат функции summary() для количественных переменных:

```{r summary, echo = FALSE, message=FALSE}
work_data[10:16] %>%
  describe() %>%
  as_tibble(rownames="Variable") %>%
  select(c("Variable", mean, sd, median, min, max, range)) %>%
  mutate(across(where(is.numeric), ~ round(., 2))) %>%
  flextable() %>%
  align(align="center")
```

Как мы видим, средние значения переменных `temp` и `atemp` довольно близки. Вероятно, следует проверить, достоверно ли они различаются или же субъективное ощущение температуры на улице не сильно отходит от реальной температуры.

Теперь посмотрим на категориальные перменные:

```{r EDA category}
summary(work_data[3:9])
```

Также видно, что большинство клиентов сервиса - зарегистрированные пользователи, в то время как случайных пользователей сильно меньше. Нерабочих дней было в 2.5 раза меньше, чем рабочих и при исследовании зависимости числа арендованных велосипедов от статуса дня это нужно будет учитывать для получения достоверных результатов.Также можно заметить, что за 2 года измерений погожих дней оказалось больше всего, в то время как дождливых/снежных - меньше всего (вариант 3 переменной `weathersit`).

### Исследование взаимодействий

Посмотрим на возможные корреляции между количественными переменными. Используем коэффициент корреляции Спирмена, так как первично не проверяем данные на нормальность распределения.

```{r correlation search, echo=F}
cor_matrix <- cor(x = work_data[, 3:16] %>% select(where(~ !is.factor(.))), 
                  use = "pairwise.complete.obs",
                  method = "spearman") #получили матрицу корреляций
cor_table <- as.data.frame(cor_matrix) #превратили ее в датафрейм
cor_table <- tibble::rownames_to_column(cor_table)

pivot_longer(data = cor_table, cols = -rowname, names_to = "param2", values_to = 'cor_coef') %>% # получили длинный формат
  ggplot(mapping = aes(x = param2, y = rowname, fill = cor_coef)) + #рисуем график
  geom_tile() + 
  scale_fill_gradient(low='white', high='darkred')+
  theme_bw() + 
  labs(x = "", y = "", fill='Spearman\ncorrelation\ncoefficient')
```

Как мы видим, для переменной `windspeed` практически не наблюдается сильной корреляции ни с одной другой количественной переменной, то же самое можно сказать и о переменной `hum`. Однако число арендованных велосипедов заметно коррелирует с температурой, как реальной, так и субъективной.

Для категориальных переменных можем, например, увидеть, что во второй год наблюдений число арендованных велосипедов было выше, чем в первый.

```{r factor cor search, echo=F, message=F, warning=F}
grouped_means <- work_data %>% select(c(mnth, yr, casual, registered, cnt)) %>%
  group_by(across(c(yr, mnth))) %>%
  summarise(mean_casual = mean(casual, na.rm=T),
            mean_reg = mean(registered, na.rm=T),
            mean_cnt = mean(cnt, na.rm=T)) %>%
  ungroup()

ggplot(data = grouped_means, aes(x = mnth, y = mean_cnt))+
  geom_bar(stat="identity", position=position_dodge())+
  facet_wrap(~ yr)+
  labs(x='Month', y='Mean number of rented bicycles')
```

Мы подготовили данные, посмотрели на основные описательные статистики и исследовали взаимодействия между переменными. Приступаем к проверке гипотез.

## Гипотеза 1

Для планирования запасов велосипедов и самокатов, оптимизации ценоообразования, планирования маркетинговых компаний и распределения бюджета на обслуживание критически важно понимание сезонной динамики спроса. В связи с этим проверим первую гипотезу:

**Летом количество пользователей сервиса проката больше чем зимой?**

H0: Количество пользователей (casual и registered) летом и зимой одинаковое

H1: Летом сервис пользуется большей популярностью, чем зимой

alpha = 0.05

```{r summer hyp normal}
# Выбираем данные за лето и зиму
summer <- work_data$cnt[work_data$season == "Summer"]
winter <- work_data$cnt[work_data$season == "Winter"]

# Проверка нормальности
shapiro.test(summer)
shapiro.test(winter)
```

Поскольку p-value в обоих случаях очень малы (намного меньше 0.05), нулевая гипотеза отвергается. Это значит, что распределения данных summer и winter статистически значимо отличаются от нормального распределения. Поэтому при анализе данных лучше использовать непараметрические тесты или учитывать ненормальность данных.

Применим тест Манна-Уитни для проверки нашей гипотезы

```{r manna test}
wilcox.test(summer, winter, alternative = "greater")
```

p-value \< 0.05, отвергаем нулевую гипотезу и считаем, что летом пользователей значительно больше.

```{r visual hyp1, echo = F}
CI_bar_data <- work_data %>%
  filter(season %in% c("Winter", "Summer")) %>%
  select(c(season, cnt)) %>%
  group_by(season) %>%
  summarise('lower' = MeanCI(cnt, conf.level = 0.95, method = 'boot', na.rm = T)["lwr.ci"],
            "upper" = MeanCI(cnt, conf.level = 0.95, method = 'boot', na.rm = T)["upr.ci"],
            'mean_cnt' = mean(cnt, na.rm=T))%>%
  mutate(season = tolower(season)) 

ggplot(data = CI_bar_data, aes(x = season, y = mean_cnt, fill = season))+
  geom_bar(stat="identity", position = 'dodge', fill=c('darkred', '#3C3C3C'))+
  geom_errorbar(aes(x=season, ymin=lower, ymax=upper), width=0.2, position = position_dodge(0.9))+
  ggsignif::geom_signif(y_position = 6300, xmin = 1, xmax = 2, annotation = "p-value < 2.2e-16")+
  labs(x = "Season", y = "Mean number of total users")
```

На основании этого статистически подтвержденного факта можно сформулировать следующие практические рекомендации для сервиса проката: увеличивать парк транспорта к летнему сезону, разработать летние маркетинговые акции для привлечения новых пользователей и планировать техническое обслуживание на зимний период.

## Гипотеза 2

Понимание поведения разных типов пользователей помогает разрабатывать целевые программы лояльности, создавать персонализированные предложения и оптимизировать сервис под нужды разных групп. В частности, важно понять, меняется ли состав пользовательской базы в зависимости от сезона. Сформулируем вторую гипотезу:

**Зимой сервисом проката преимущественно пользуются зарегистрированные пользователи**

H0: Доля зарегистрированных пользователей летом и зимой одинакова

H1: Зимой сервисом пользуются в основном зарегистрированные клиенты

alpha = 0.05

Для проверки гипотезы рассчитаем долю зарегистрированных пользователей как отношение количества зарегистрированных пользователей к общему количеству пользователей: registered_ratio = registered / (registered + casual)

```{r hyp2}
# Создаем столбец с долей зарегистрированных пользователей
work_data$registered_ratio <- work_data$registered / work_data$cnt

# Выбираем данные за лето и зиму
registered_ratio_summer <- work_data$registered_ratio[work_data$season == "Summer"]
registered_ratio_winter <- work_data$registered_ratio[work_data$season == "Winter"]

# Проводим тест Манна-Уитни с альтернативной гипотезой, что зимой доля больше
wilcox.test(registered_ratio_winter, registered_ratio_summer, alternative = "greater")

```

```{r visual hyp2, echo = F}
CI_ratio_data <- work_data %>%
  filter(season %in% c("Winter", "Summer")) %>%
  select(c(season, registered_ratio)) %>%
  group_by(season) %>%
  summarise('lower' = MeanCI(registered_ratio, conf.level = 0.95, method = 'boot', na.rm = T)["lwr.ci"],
            "upper" = MeanCI(registered_ratio, conf.level = 0.95, method = 'boot', na.rm = T)["upr.ci"],
            'mean_ratio' = mean(registered_ratio, na.rm = T)) %>%
  mutate(season = tolower(season))

ggplot(data = CI_ratio_data, aes(x = season, y = mean_ratio, fill = season)) +
  geom_bar(stat = "identity", position = 'dodge', fill = c('darkred', '#3C3C3C')) +
  geom_errorbar(aes(x = season, ymin = lower, ymax = upper), width = 0.2, position = position_dodge(0.9)) +
  ggsignif::geom_signif(y_position = 0.95, xmin = 1, xmax = 2, annotation = "p-value < 2.2e-16") +
  labs(x = "Season", y = "Mean ratio of registered users")
```

В данном случае тест показал статистику около 25883 и очень маленькое значение p (около 2.2e-16), что говорит о значимом различии в долях зарегистрированных пользователей: зимой эта доля действительно значительно выше, чем летом.

Подтверждено, что зимой сервисом преимущественно пользуются зарегистрированные пользователи. Рекомендуем сфокусировать зимние маркетинговые усилия на удержании постоянных клиентов через программы лояльности и специальные условия. Это позволит максимизировать доход в низкий сезон за счет лояльной аудитории.

## Гипотеза 3

**Различаются ли количество аренд велосипедов в нерабочие и рабочие дни?**

Проверим гипотезу: есть ли различие в среднем числе аренд между рабочими и нерабочими днями?

H₀: среднее количество аренд велосипедов в рабочие и нерабочие дни одинаково,

H₁: средние значения количества аренд велосипедов в рабочие и нерабочие дни различаются.

alpha = 0.05

```{r hyp3}

# рабочие (1) и нерабочие (0) дни
table(work_data$workingday)

# разделяем данные по рабочим и нерабочим дням
# cnt - общее количество арендованных велосипедов за день
cnt_working <- work_data$cnt[work_data$workingday == "yes"]
cnt_nonworking <- work_data$cnt[work_data$workingday == "no"]

# для проверки нормального распределения данных проводим тест Шапиро-Уилка
shapiro.test(cnt_working)
shapiro.test(cnt_nonworking)
```

В обоих случаях p \< 0.05, это означает, что распределения данных ненормальные. Это подтверждается и по гистограммам, которые показывают, что данные имеют смещение и не похожи на нормальное распределение.

```{r visual hyp3 norm, echo=F}
# визуализация
hist(cnt_working, main="Working days", xlab="Total number of bicycles rented per day")
hist(cnt_nonworking, main="Non-working days", xlab="Total number of bicycles rented per day")
```

Таким образом, для проверки гипотезы используем непараметрический критерий Манна-Уитни, U-тест

```{r}
#применяем тест Манна-Уитни
wilcox.test(cnt_working, cnt_nonworking, alternative = "two.sided")
```

В результате теста Манна-Уитни, полученное значение p-value = 0.1002 \> 0.05, нулевая гипотеза не отвергается. Следовательно, статистически значимых различий в количестве аренд велосипедов между рабочими и нерабочими днями не обнаружено.

```{r visual hyp3, echo = F}
CI_bar_data <- work_data %>%
  select(c(workingday, cnt)) %>%
  group_by(workingday) %>%
  summarise('lower' = MeanCI(cnt, conf.level = 0.95, method = 'boot', na.rm = T)["lwr.ci"],
            "upper" = MeanCI(cnt, conf.level = 0.95, method = 'boot', na.rm = T)["upr.ci"],
            'mean_cnt' = mean(cnt, na.rm=T))%>%
  mutate(workingday = c("no", "yes"))

ggplot(data = CI_bar_data, aes(x = workingday, y = mean_cnt, fill = workingday))+
  geom_bar(stat="identity", position = 'dodge', fill=c('darkred', '#3C3C3C'))+
  geom_errorbar(aes(x=workingday, ymin=lower, ymax=upper), width=0.2, position = position_dodge(0.9))+
  labs(x = "Working day", y = "Mean number of total users")
```

## Выводы

Нами был проведён анализ и предварительная подготовка данных сервиса проката велосипедов в Вашингтоне за 2011-2012 гг. Был загружен датасет, состоящий из 731 наблюдения за 2 года. Мы проверили его структуру и исправили некорректные типы переменных. Были удалены отсутствующие значения, выявлены и исключены явные выбросы, а категориальным переменным присвоены правильные факторы.

Разведочный анализ показал, что:

-   подавляющее большинство клиентов - это зарегистрированные пользователи,

-   количество арендованных велосипедов зависит от температуры,

-   во второй год наблюдений количество аренд в среднем были выше, чем в первый год.

В процессе анализа данных сервиса проката велосипедов в Вашингтоне за 2011-2012 гг. нами была осуществлена проверка трех гипотез, отражающих влияние сезона и календарных факторов на использование сервиса.

**Гипотеза 1**: Летом количество пользователей сервиса проката больше чем зимой.

-   Проверка нормальности по тесту Шапиро-Уилка показало, что распределения данных ненормальные, следовательно был выбран Манн-Уитни U-тест

-   По результатам непараметрического теста Манна-Уитни была отвергнута нулевая гипотеза (p-value \< 0.05).

-   Таким образом, пользователи обращаются к сервису проката велосипедов летом статистически значимо чаще, чем зимой.

**Гипотеза 2**: Зимой сервисом проката преимущественно пользуются зарегистрированные пользователи.

-   Для анализа была рассчитана доля зарегистрированных пользователей среди всех аренд.

-   Непараметрический тест Манна-Уитни показал очень малое значение p-value (≈ 2.2×10\^(−16)), что свидетельствует о наличии значимых различий, нулевая гипотеза отвергнута.

-   Таким образом, в зимний период доля зарегистрированных клиентов действительно выше, чем летом, то есть случайные пользователи менее активны в холодное время года.

**Гипотеза 3**: Различаются ли количество аренд велосипедов в нерабочие и рабочие дни?

-   Тесты Шапиро-Уилка на нормальность показали ненормальное распределение данных, поэтому использовался непараметрический критерий Манна-Уитни U-тест.

-   Полученное значение p-value = 0.1002, что больше 0.05, следовательно нулевая гипотеза не отвергнута.

-   Таким образом, статистически значимых различий в числе аренд между рабочими и нерабочими днями не выявлено. Хотя, предположительно можно ожидать более высокую активность пользователей аренды велосипедов в выходные дни, но данные за 2011-2012 гг. этого не подтверждают.

Исходя из анализа данных и проверки трех гипотез можно сделать вывод, что сезон и статус пользователя оказывают более значимое влияние на использование сервиса проката велосипедов, тогда как фактор рабочий или нерабочий день статистически значимого эффекта не продемонстрировал.
